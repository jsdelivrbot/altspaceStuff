<html>
<head>
	<script src="https://aframe.io/releases/0.3.0/aframe.min.js"></script>
	<script src="https://cdn.rawgit.com/AltspaceVR/AltspaceSDK/v2.6.1/dist/altspace.min.js"></script>

	<script>
	// Gets tracking and stuff. Maybe.
    altspace.getThreeJSTrackingSkeleton().then(function (skeleton) {
          window.head = skeleton.getJoint('Head');
        });
        AFRAME.registerComponent('altspace-look-at', {
          init: function () {
            if (!window.altspace || !altspace.inClient) { return; }
          },
          tick: function () {
            if (!window.head || !this.el.object3D) { return; }
            this.el.object3D.lookAt(window.head.position); 
          }
        })
	</script>

	<script>
    // n-skeleton-parent only works with root meshes at the moment. Since most model loaders use a root
    // container object, we need to collapse the model so that n-skeleton-parent can access the mesh directly.
    AFRAME.registerComponent('collapse-model', {
        init: function () {
            this.el.addEventListener('model-loaded', function () {
                this.el.object3DMap.mesh.updateMatrixWorld();
                var mesh;
                this.el.object3DMap.mesh.traverse(function (obj) {
                    if (!mesh && obj instanceof THREE.Mesh) {
                        mesh = obj;
                    }
                }.bind(this))
                if (mesh) {
                    this.el.sceneEl.object3D.updateMatrixWorld(true);
                    mesh.scale.copy(mesh.getWorldScale());
                    this.el.setObject3D('mesh', mesh);
                    // setObject3D emits this event in a-frame 0.4.0
                    this.el.emit('object3dset', {
                        type: 'mesh'
                    });
                }
            }.bind(this));
        }
    });
	</script>
</head>

<body>
<a-scene altspace='fullspace:true' sync-system="author: meeka; app: mkahead;">

    <a-assets>
    	<!--Body Assets-->
    	<a-asset-item id="mkahead-obj" src="assets/obj/mkahead.obj"></a-asset-item>
    	<a-asset-item id="mkahead-mtl" src="assets/obj/mkahead.mtl"></a-asset-item>
    	<a-asset-item id="mkarh-obj" src="assets/obj/mkarh.obj"></a-asset-item>
    	<a-asset-item id="mkarh-mtl" src="assets/obj/mkarh.mtl"></a-asset-item>
    	<a-asset-item id="mkalh-obj" src="assets/obj/mkalh.obj"></a-asset-item>
    	<a-asset-item id="mkalh-mtl" src="assets/obj/mkalh.mtl"></a-asset-item>

    	<!--Body Mixins-->
        <a-mixin id="mkahead" obj-model="obj: #mkahead-obj; mtl: #mkahead-mtl" collapse-model scale="1 1 1"></a-mixin>
        <a-mixin id="mkarh" obj-model="obj: #mkarh-obj; mtl: #mkarh-mtl" collapse-model scale="1 1 1"></a-mixin>
        <a-mixin id="mkalh" obj-model="obj: #mkalh-obj; mtl: #mkalh-mtl" collapse-model scale="1 1 1"></a-mixin>

        <!--Positioning-->
        <a-mixin id="head" rotation="0 180 0" position="0 .075 0" n-skeleton-parent="part: head; side: center;" sync sync-n-skeleton-parent></a-mixin>
        <a-mixin id="righthand" rotation="90 180 0" position="-.03 -.015 -.25" n-skeleton-parent="part: hand; side: right;" sync sync-n-skeleton-parent></a-mixin>
        <a-mixin id="lefthand" rotation="90 180 0" position=".04 -.010 -.25" n-skeleton-parent="part: hand; side: left;" sync sync-n-skeleton-parent></a-mixin>

        <!--Selector(s)-->
        <a-mixin id="button" geometry="primitive: cylinder" material="color: red">

    </a-assets>

        <a-entity id="app" position="1 1 0" rotation="0 180 0">
        	<a-entity id="mkhead-on" mixin="button" instantiator="on: click; group: mkahead; mixin: mkahead head;" position="0 1.5 0" rotation="0 90 90" scale=".1 .1 .1"></a-entity>
        	<a-entity id="mkarh-on" mixin="button" instantiator="on: click; group: mkarh; mixin: mkarh righthand;" position=".25 1.5 0" rotation="0 90 90" scale=".1 .1 .1"></a-entity>
        	<a-entity id="mkalh-on" mixin="button" instantiator="on: click; group: mkalh; mixin: mkalh lefthand;" position="-.25 1.5 0" rotation="0 90 90" scale=".1 .1 .1"></a-entity>

       		<a-entity n-text='text: Do not click this button.\n It will crash your game.\n Every now and then, however, there is an offchance it could make you fabulous, possibly.; fontSize: 1; width: 2;' position="0 1 0"></a-entity>
        </a-entity>
</a-scene>
</body>
</html>	